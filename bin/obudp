#!/usr/bin/env python3
# -*- coding: utf-8 -*-

""" udp client program. """

import os; import sys; sys.path.insert(0, os.getcwd())

from ob.cls import Cfg
from ob.shl import parse_cli
from ob.trc import get_exception
from ob.utl import strip_html

import logging
import select
import socket

udp = Cfg()
udp.cfg = "udp"
udp.host = "localhost"
udp.port = 5500
udp.password = "boh"
udp.seed = "blablablablablaz" # needs to be 16 chars wide
udp.server = udp.host
udp.owner = ""

def out(txt):
    """ output text to the bot. """
    #txt = strip_html(str(txt))
    data = '%s %s' % (udp.password, txt.strip())
    sock = socket.socket(socket.AF_INET6, socket.SOCK_DGRAM)
    sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
    sock.sendto(bytes(data, "utf-8"), (udp.host, udp.port))

def main():
    """ listen on stdin and forward received data to the bot. """
    cfg = parse_cli()
    fd = None
    if cfg.args:
        if os.path.exists(cfg.args[0]):
            f = open(cfg.args[0], "r")
        else:
            out(" ".join(cfg.args))
            return
    if not fd:
        fd = f.fileno()
    else:
        for txt in f.readlines():
            out(txt)
        return
    while 1:
        (i, o, e) = select.select([f], [], [sys.stderr,])
        if e:
            break
        stop = False
        for sock in i:
            try:
                txt = sock.readline()
                if not txt:
                    stop = True
                    break
                out(txt)
            except:
                logging.error(get_exception())
        if stop:
            break

if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        pass
