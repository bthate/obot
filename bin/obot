#!/usr/bin/python3 -u

""" object bot. """

import os, sys ; sys.path.insert(0, os.getcwd())

import json
import ob
import obot
import os
import time
import threading

from ob import Object, k, __version__
from ob.dpt import dispatch
from ob.pst import Persist
from ob.shl import execute, hd, parse_cli, set_completer
from ob.tms import elapsed
from ob.utl import get_name, mods

opts = [
    ('-d', '', 'string', "", 'workdir', 'set working directory.'),
    ('-l', '', 'string', '', 'level', 'loglevel.'),
    ('-m', '', 'string', '', 'modules', 'modules to load.'),
    ('-o', '', "string", "", 'options', "options to use."),
    ('-s', '', 'store_true', False, 'dosave', 'save configuration files.'),
    ('-v', '', 'store_true', False, 'verbose', 'enable verbose mode.'),
    ('-x', '', 'string', '', 'exclude', 'skip modules'),
]

class Log(Persist):

    def __init__(self):
        super().__init__()
        self.txt = ""

class Todo(Persist):

    def __init__(self):
        super().__init__()
        self.txt = ""

def cmds(event):
    event.reply("|".join(sorted(k.cmds)))

def log(event):
    if not event.rest:
        nr = 0
        event.options += "t"
        if not event.dkeys:
            event.dkeys.append("txt")
        for o in k.db.find("__main__.Log", event.selector or {"txt": ""}):
            event.display(o, "%-2s" % str(nr))
            nr += 1
        return
    obj = Log()
    obj.txt = event.rest
    obj.save()
    event.reply("ok")

def todo(event):
    if not event.rest:
        nr = 0
        event.options += "t"
        if "txt" not in event.dkeys:
            event.dkeys.append("txt")
        for o in k.db.find("__main__.Todo", event.selector or {"txt": ""}):
            event.display(o, "%-2s" % str(nr))
            nr += 1
        return
    obj = Todo()
    obj.txt = event.rest
    obj.save()
    event.reply("ok")

def main():
    parse_cli("obot", __version__, opts, hd(".obot"), "obot -m mod1,mod2")
    k.walk(__name__)
    k.init(k.cfg.modules)        
    k.register(dispatch)
    k.start()
    k.wait()

execute(main)
os._exit(0)
